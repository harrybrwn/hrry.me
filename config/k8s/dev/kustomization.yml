bases:
  - ../app

commonLabels:
  environment: dev

resources:
  - issuer.yml
  - certificates.yml
  - sendgrid-secrets.yml
  - ingress-routes.yml

# Patch the certificate volumes to use the ones issued by cert-manager.
patchesStrategicMerge:
  - patches/web-api.yml

# NOTES:
# generator behavior can be 'create', 'replace', 'merge'
secretGenerator:
  # CA for self-signed issuer
  - name: hrry-root-ca
    behavior: create
    options:
      disableNameSuffixHash: true
    files:
      - tls.crt=certs/ca.crt
      - tls.key=certs/ca.key
  - name: jwt-secrets
    behavior: merge
    literals:
      - jwt-seed=505f0ed4a438f73454a8d8dfc5741327ffa73203be34f5a58db367591124282b
  - name: db-env-secrets
    behavior: replace
    literals:
      - POSTGRES_USER=harrybrwn
      - POSTGRES_PASSWORD=testbed01
      - POSTGRES_USERS=grafana:testbed02 db-backups:testbed03 hydra:testbed04
      - POSTGRES_DATABASES=harrybrwn_api:harrybrwn harrybrwn_hooks:harrybrwn grafana:grafana
  - name: redis-secrets
    behavior: replace
    literals:
      - password=testbed01
  - name: minio-env-secrets
    behavior: create
    literals:
      - MINIO_ROOT_USER=root
      - MINIO_ROOT_PASSWORD=minio-testbed001
  - name: grafana-env
    behavior: merge
    literals:
      - GF_DATABASE_PASSWORD=testbed02
      - GF_REMOTE_CACHE_CONNSTR=addr=redis:6379,pool_size=50,db=1,password=testbed01
      - GF_SECURITY_ADMIN_PASSWORD=testbed01
  - name: loki
    behavior: merge
    literals:
      - s3-access-key=loki
      - s3-secret-key=minio-testbed001-loki
  - name: web-api-secrets
    behavior: merge
    literals:
      - postgres-password=testbed01
  - name: hooks-env-secrets
    behavior: replace
    literals:
      - GITHUB_CLIENT_ID=123
      - GITHUB_CLIENT_SECRET=12345
      - GITHUB_CALLBACK_SECRET=abcde
      - POSTGRES_PASSWORD=testbed04


configMapGenerator:
  - name: nginx
    behavior: replace
    literals:
      - registry-url=https://registry.hrry.local
  - name: minio-env-config
    behavior: merge
    literals:
      - MINIO_LOGGER_WEBHOOK_ENABLE_PRIMARY=on
      - MINIO_LOGGER_WEBHOOK_ENDPOINT_PRIMARY=http://hooks:8889/hooks/minio/logs
      - MINIO_AUDIT_WEBHOOK_ENABLE_PRIMARY=on
      - MINIO_AUDIT_WEBHOOK_ENDPOINT_PRIMARY=http://hooks:8889/hooks/minio/audit
  - name: hooks-env-config
    behavior: merge
    literals:
      - GH_HOOK_CALLBACK_HOST=hooks.harrybrwn.com
      - POSTGRES_HOST=db
      - POSTGRES_USER=harrybrwn
  - name: grafana-env
    behavior: merge
    envs: [grafana.env]

patches:
  # Make sure all the certificates have the correct issuer
  - target:
      kind: Certificate
    patch: |-
      - op: replace
        path: /spec/issuerRef/name
        value: ca-issuer
