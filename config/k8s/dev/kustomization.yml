bases:
  - ../app
  - ../common/helm-charts

commonLabels:
  environment: dev

resources:
  - issuer.yml
  - certificates.yml
  - sendgrid-secrets.yml
  - ingress-routes.yml

# Patch the certificate volumes to use the ones issued by cert-manager.
patchesStrategicMerge:
  - patches/web-api.yml

# NOTES:
# generator behavior can be 'create', 'replace', 'merge'
secretGenerator:
  # CA for self-signed issuer
  - name: hrry-root-ca
    behavior: create
    options:
      disableNameSuffixHash: true
    files:
      - tls.crt=certs/ca.crt
      - tls.key=certs/ca.key
  - name: jwt-secrets
    behavior: merge
    literals:
      - jwt-seed=505f0ed4a438f73454a8d8dfc5741327ffa73203be34f5a58db367591124282b
  - name: db-env-secrets
    behavior: replace
    literals:
      - POSTGRES_USER=harrybrwn
      - POSTGRES_PASSWORD=testbed01
      - POSTGRES_USERS=grafana:testbed02 db-backups:testbed03 hydra:testbed04
      - POSTGRES_DATABASES=harrybrwn_api:harrybrwn harrybrwn_hooks:harrybrwn grafana:grafana
  - name: redis-secrets
    behavior: replace
    literals:
      - password=testbed01
  - name: minio-env-secrets
    behavior: create
    literals:
      - MINIO_ROOT_USER=root
      - MINIO_ROOT_PASSWORD=minio-testbed001
  - name: grafana-env
    behavior: replace
    literals:
      - GF_DATABASE_PASSWORD=testbed02
      - GF_REMOTE_CACHE_CONNSTR=addr=redis:6379,pool_size=50,db=4,password=testbed01
      - GF_SECURITY_ADMIN_PASSWORD=testbed01
  - name: loki
    behavior: replace
    literals:
      - s3-access-key=loki
      - s3-secret-key=minio-testbed001-loki
  - name: web-api-env
    behavior: replace
    literals:
      - POSTGRES_PASSWORD=testbed01
  - name: hooks-env-secrets
    behavior: replace
    literals:
      - GITHUB_CLIENT_ID=123
      - GITHUB_CLIENT_SECRET=12345
      - GITHUB_CALLBACK_SECRET=abcde
      - POSTGRES_PASSWORD=testbed04
  - name: outline-env
    behavior: merge # Merge there are useful defaults
    literals:
    - SECRET_KEY=4823b18f05753c43c8e26566ab51ec02f639a31bd182419d5c1caa4cb257f2f7
    - UTILS_SECRET=6909b3a32c304d274910dc51f07f18add342ca2927ccd9a6cc53271220860c41
    # - DATABASE_URL=
    # - REDIS_URL=redis://:testbed01
    # - REDIS_PASSWORD=
  - name: hydra-client-migrations
    behavior: replace
    files:
      - files/clients/grafana.json
      - files/clients/outline.json
  - name: registry-secrets
    behavior: replace
    files:
      # contains users:
      #   harry:fdsafdsa
      #   harrybrwn:fdsafdsa
      - files/registry/htpasswd
  - name: registry-secrets-env
    behavior: replace
    literals:
      - REGISTRY_REDIS_PASSWORD=testbed01
      - REGISTRY_REDIS_DB=5
      - REGISTRY_HTTP_SECRET=1111110000001c6b90c320c622890c5a4b3d6ab0ff35da087df17616c931cd75
      - REGISTRY_STORAGE_S3_REGIONENDPOINT=http://s3:9000/
      - REGISTRY_STORAGE_S3_BUCKET=docker-registry
      - REGISTRY_STORAGE_S3_REGION=us-east-1
      - REGISTRY_STORAGE_S3_ACCESSKEY=registry
      - REGISTRY_STORAGE_S3_SECRETKEY=minio-testbed001-registry

configMapGenerator:
  - name: nginx
    behavior: replace
    literals:
      - registry-url=https://cr.hrry.io.local
  - name: minio-env-config
    behavior: merge
    literals:
      - MINIO_LOGGER_WEBHOOK_ENABLE_PRIMARY=on
      - MINIO_LOGGER_WEBHOOK_ENDPOINT_PRIMARY=http://hooks:8889/hooks/minio/logs
      - MINIO_AUDIT_WEBHOOK_ENABLE_PRIMARY=on
      - MINIO_AUDIT_WEBHOOK_ENDPOINT_PRIMARY=http://hooks:8889/hooks/minio/audit
  - name: hooks-env-config
    behavior: merge
    literals:
      - GH_HOOK_CALLBACK_HOST=hooks.harrybrwn.com
      - POSTGRES_HOST=db
      - POSTGRES_USER=harrybrwn
  - name: grafana-env
    behavior: merge
    literals:
    - GF_DATABASE_TYPE=postgres
    - GF_DATABASE_HOST=db:5432
    - GF_DATABASE_NAME=grafana
    - GF_DATABASE_USER=grafana
    - GF_REMOTE_CACHE_TYPE=redis
  - name: outline-env
    behavior: merge
    literals:
      - URL=https://wiki.hrry.local
      - PGSSLMODE=disable
  - name: registry-config
    behavior: replace
    files:
      - files/registry/config.yml

patches:
  # Make sure all the certificates have the correct issuer
  - target:
      kind: Certificate
    patch: |-
      - op: replace
        path: /spec/issuerRef/name
        value: ca-issuer

images:
  - name: 10.0.0.11:5000/harrybrwn/s3
    newName: 10.0.0.11:5000/harrybrwn/s3
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/fluent-bit
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/loki
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/redis
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/postgres
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/nginx
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/grafana
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/outline
    newTag: latest
  - name: 10.0.0.11:5000/harrybrwn/curl
    newTag: latest
