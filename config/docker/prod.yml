version: "3.8"

services:
  db:
    deploy:
      replicas: 1
      placement:
        max_replicas_per_node: 1
        constraints:
          - "node.role==manager"
      restart_policy:
        condition: on-failure
        max_attempts: 3
        delay: 2s
    env_file:
      - config/env/prod/db.env
      - config/env/swarm_data.env

  redis:
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 3
        delay: 2s
    env_file:
      - config/env/swarm_data.env

  nginx:
    deploy:
      endpoint_mode: vip
      placement:
        constraints:
          - "node.role==manager"
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    volumes:
      # harrybrwn.com
      - /etc/letsencrypt/live/harrybrwn.com/fullchain.pem:/etc/harrybrwn.com/server.crt:ro
      - /etc/letsencrypt/live/harrybrwn.com/privkey.pem:/etc/harrybrwn.com/server.key:ro
      # hryb.dev
      - /etc/letsencrypt/live/hryb.dev/fullchain.pem:/etc/hryb.dev/server.crt:ro
      - /etc/letsencrypt/live/hryb.dev/privkey.pem:/etc/hryb.dev/server.key:ro
      # hrry.me
      - /etc/letsencrypt/live/hrry.me/fullchain.pem:/etc/hrry.me/server.crt:ro
      - /etc/letsencrypt/live/hrry.me/privkey.pem:/etc/hrry.me/server.key:ro
      # hrry.dev
      - /etc/letsencrypt/live/hrry.dev/fullchain.pem:/etc/hrry.dev/server.crt:ro
      - /etc/letsencrypt/live/hrry.dev/privkey.pem:/etc/hrry.dev/server.key:ro
    environment:
      - REGISTRY_URL=https://registry.hryb.dev
    env_file:
      - config/env/swarm_data.env

  api:
    hostname: '{{.Task.Name}}-{{.Node.Hostname}}'
    deploy:
      replicas: 4
      placement:
        max_replicas_per_node: 2
        constraints:
          - "node.role==worker"
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
      update_config:
        parallelism: 1
        delay: 2s
        order: stop-first
    environment:
      - ENV=production
      - LOG_FORMAT=json
    env_file:
      - config/env/sendgrid.env
      - config/env/prod/db.env
      - config/env/prod/jwt.env
      - config/env/swarm_data.env
      # - config/env/api.prod.env

  hooks:
    env_file:
      - config/env/sendgrid.env
      - config/env/db.prod.env
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
    environment:
      - ENV=production
      - LOG_FORMAT=json
    env_file:
      - config/env/swarm_data.env

  backups:
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 3
      placement:
        constraints:
          - "node.role==worker"
    env_file:
      - config/env/prod/db-backup.env
      - config/env/swarm_data.env
    environment:
      - ENV=production
      - LOG_FORMAT=json

  geoip:
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 3
      placement:
        constraints:
          - "node.role==worker"
    env_file:
      - config/env/swarm_data.env
    environment:
      - ENV=production
      - LOG_FORMAT=json

  fluentbit:
    # hostname: '{{ .Task.Name }}-{{ .Node.Hostname }}'
    hostname: 'fluentbit-{{ .Node.Hostname }}'
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 5
    env_file:
      - config/env/swarm_data.env
    environment:
      - ENV=production

  loki:
    env_file:
      - config/env/db.prod.env
    deploy:
      replicas: 1
      placement:
        constraints: [node.labels.logs == true]
      restart_policy:
        condition: on-failure
        max_attempts: 5
        delay: 10s
    env_file:
      - config/env/swarm_data.env
      - config/env/prod/loki.env

  grafana:
    deploy:
      placement:
        constraints: [node.labels.logs == true]
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 5
        delay: 10s
    env_file:
      - config/env/prod/db.env
      - config/env/swarm_data.env

  prometheus:
    deploy:
      replicas: 1
      placement:
        constraints: [node.labels.logs == true]
      restart_policy:
        condition: on-failure
        max_attempts: 5
        delay: 10s
    env_file:
      - config/env/swarm_data.env

  registry:
    volumes:
      - registry:/var/lib/registry
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        max_attempts: 6
      placement:
        max_replicas_per_node: 2
    env_file:
      - config/env/prod/minio.env
      - config/env/swarm_data.env

  s3:
    deploy:
      replicas: 1
      placement:
        max_replicas_per_node: 1
        constraints: [node.labels.s3 == true]
      restart_policy:
        condition: on-failure
        max_attempts: 3
    env_file:
      - config/env/prod/minio.env
      - config/env/swarm_data.env
    environment:
      - MINIO_BROWSER_REDIRECT_URL=https://s3-console.hryb.dev

volumes:
  registry:
    external: true
