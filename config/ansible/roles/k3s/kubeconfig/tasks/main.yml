- name: Grab k3s kubeconfig content
  slurp:
    path: ~{{ ansible_user }}/.kube/config
  register: kubeconfig

- name: Copy the data to local machine
  copy:
    content: "{{ kubeconfig.content | b64decode }}"
    dest: "~/.kube/k3s-{{ k3s_master_ip }}"
  delegate_to: localhost
  become: false
  run_once: true

- name: Merge in new config
  block:
    - name: Create .kube directory
      file:
        path: ~/.kube
        state: directory
    - name: Replace 'default' for the config name
      shell:
        executable: /usr/bin/bash
        cmd: |
          set -eu
          sed -Ei \
            -e 's/cluster:[ ]*default/cluster: {{ k3s_config_name }}/g;' \
            -e 's/name:[ ]*default/name: {{ k3s_config_name }}/g;'       \
            -e 's/user:[ ]*default/user: {{ k3s_config_name }}/g;'       \
            ~/.kube/k3s-{{ k3s_master_ip }}
            kubectl --kubeconfig ~/.kube/k3s-{{ k3s_master_ip }} config use-context {{ k3s_config_name }}
    - name: Merge with the current config
      shell:
        executable: /usr/bin/bash
        cmd: |
          set -eu
          KUBECONFIG="${HOME}/.kube/k3s-{{ k3s_master_ip }}"
          if [ -f "${HOME}/.kube/config" ]; then
            KUBECONFIG="${KUBECONFIG}:${HOME}/.kube/config"
          fi
          export KUBECONFIG
          kubectl config view --flatten --raw > "${HOME}/.kube/_tmp_config"
          rm -f "${HOME}/.kube/config"
      register: out
    - name: Replace config with the new merged config
      shell:
        executable: /usr/bin/bash
        cmd: |
          set -eu
          mv "${HOME}/.kube/_tmp_config" "${HOME}/.kube/config"
          chmod 0600 ${HOME}/.kube/config
    - name: Set to current-context
      shell:
        executable: /usr/bin/bash
        cmd: |
          export KUBECONFIG=${HOME}/.kube/config
          kubectl config use-context {{ k3s_config_name }}
  delegate_to: localhost
  become: false
  run_once: true
