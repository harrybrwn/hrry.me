server {
	server_name hrry.dev www.hrry.dev;
	listen      80;
	listen [::]:80;
	listen      443 http2;
	listen [::]:443 http2;
	server_tokens off;
	include 'snippets/hrry.dev-ssl';
	location / {
		return 301 https://hrry.me/;
	}
}

server {
	server_name ip.hrry.dev ip.hrry.local;

	listen      80;
	listen [::]:80;
	listen      443 ssl http2;
	listen [::]:443 ssl http2;
	include 'snippets/hrry.dev-ssl';
	server_tokens off;

	set $geoip geoip:8084;

	location / {
		proxy_set_header  Host              $http_host;
		proxy_set_header  X-Real-IP         $remote_addr;
		proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header  X-Forwarded-Proto $scheme;
		proxy_pass        http://$geoip;
	}

	location /metrics {
		return 404;
	}
}

server {
	server_name gopkg.hrry.dev
				gopkg.hrry.local;

	listen      80;
	listen [::]:80;
	listen      443 ssl http2;
	listen [::]:443 ssl http2;
	include 'snippets/hrry.dev-ssl';
	server_tokens off;

	set $server vanity-imports:8085;

	location / {
		proxy_pass http://$server;
		# cache in browser for 1 day
		#add_header Cache-Control "public, max-age=86400, must-revalidate, proxy-revalidate";
	}

	location /metrics {
		return 404;
	}
}

server {
	server_name files.hrry.dev files.hrry.local;
	listen      443 ssl http2;
	listen [::]:443 ssl http2;
	include 'snippets/hrry.dev-ssl';
	server_tokens off;
	set $filestash filestash:8334;

	# file upload limit
	client_max_body_size 4G;

	location / {
		proxy_buffers  32 256k;
		proxy_buffer_size 64k;

		proxy_http_version 1.1;
		proxy_set_header   Upgrade           $http_upgrade;
		proxy_set_header   Connection        "upgrade";
		proxy_set_header   Host              $host;
		proxy_set_header   X-Real-IP         $remote_addr;
		proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
		proxy_set_header   Origin '';

		# TODO figure this out
		#add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

		proxy_pass http://$filestash;
		add_header Cache-Control "private";
	}
}

server {
	server_name static.hrry.dev
				static.hrry.local;

	listen      443 ssl http2;
	listen [::]:443 ssl http2;

	include 'snippets/hrry.dev-ssl';
	server_tokens off;
	set $s3 s3:9000;

	location / {
		autoindex        on;
		rewrite ^/$ /index.html break;
		proxy_set_header Host $http_host;
		proxy_pass       http://$s3/frontend/latest/harrybrwn.com$request_uri;
		# cache in browser for 1 day
		add_header Cache-Control "public, max-age=86400, must-revalidate";
	}
}