# Configure for container networking (see https://github.com/docker/compose/issues/3412)
resolver 127.0.0.11;

server {
	listen 80;
	listen [::]:80;
	server_tokens off;

	return 301 https://$host$request_uri;
}

upstream backend {
	server api:8081;
	server api:8081;
}

server {
	set $api api:8081;

	listen 443 ssl http2;
	listen [::]:443 ssl http2;
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_certificate     /etc/letsencrypt/live/harrybrwn.com/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/harrybrwn.com/privkey.pem;
	server_tokens off;

	server_name harrybrwn.com harrybrwn.local;

	# Disable compression (see http://www.breachattack.com/)
	gzip off;

	error_page 404 /404.html;

	location /api/ {
		proxy_pass http://backend;
	}

	location /old {
		proxy_pass http://$api$request_uri;
	}

	location /tanya {
		proxy_pass http://$api$request_uri;
	}

	location /invite {
		proxy_pass http://$api$request_uri;
	}

	error_page 500 501 502 503 504 505 506 507 508 510 511 /50x.html;

	location / {
		error_page 401 402 403 404 405 406 407 /404.html;
		autoindex on;
		root /var/www/harrybrwn.com;
	}

	location /static/ {
		gzip on;
		include snippets/static_gzip.types;
		# Only gzip if 512 bytes or more
		gzip_min_length 512;
		root /var/www/harrybrwn.com;
	}

	location = /sitemap.xml.gz {
		gzip_static on;
		expires max;
		add_header Cache-Control public;
		types { } default_type "application/gzip";
		root /var/www/harrybrwn.com;
	}

	location = /404.html {
		internal;
		allow all;
		auth_basic off;
		root /var/www/harrybrwn.com;
	}

	location ~ ^/(invite_email|harry_y_tanya) {
		error_page 404 /404.html;
		return 404;
	}
}
