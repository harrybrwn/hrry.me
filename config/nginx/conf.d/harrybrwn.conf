# Configure for container networking (see https://github.com/docker/compose/issues/3412)
resolver 127.0.0.11;

server {
	server_name _;

	listen 80;
	listen [::]:80;
	server_tokens off;

	if ($http_upgrade_insecure_requests = "1") {
		return 301 https://$host$request_uri;
	}

	error_page 404 /404.html;
	root /var/www/harrybrwn.com;

	location = /404.html {
		internal;
		allow      all;
		auth_basic off;
	}

	location ~ ^/(robots.txt|favicon.ico|sitemap.xml|manifest.json)$ {
		try_files $uri /404.html;
	}

	location / {
		return 404;
	}
}

ssl_protocols       TLSv1.2 TLSv1.3;
ssl_certificate     '/etc/harrybrwn.com/server.crt';
ssl_certificate_key '/etc/harrybrwn.com/server.key';

server {
	server_name hooks.harrybrwn.com hooks.harrybrwn.local;

	listen      443 ssl http2;
	listen [::]:443 ssl http2;
	server_tokens off;

	root /var/www/hooks.harrybrwn.com;

	location / {
		proxy_pass http://hooks:8889;
	}
}

server {
	server_name cdn.harrybrwn.com cdn.harrybrwn.local;
	listen      443 ssl http2;
	listen [::]:443 ssl http2;
	server_tokens off;

	location /static/ {
		root /var/www/hooks.harrybrwn.com;
		include snippets/static_gzip.types;
		gzip on;
		# Only gzip if 512 bytes or more
		gzip_min_length    512;
		# cache in cdn for 7 days
		add_header         Cache-Control "public, proxy-revalidate, max-age=604800";
		# cache in browser for 1 hour
		add_header         Cache-Control "public, must-revalidate, max-age=3600";
		tcp_nopush         on;
		sendfile           on;
		sendfile_max_chunk 512k;
	}
}

server {
	server_name harrybrwn.com
				www.harrybrwn.com
				harrybrwn.local
				www.harrybrwn.local;
	set $api api:8081;

	listen      443 ssl http2 default_server;
	listen [::]:443 ssl http2 default_server;
	server_tokens off;
	# Disable compression (see http://www.breachattack.com/)
	gzip off;
	error_page 500 501 502 503 504 505 506 507 508 510 511 /50x.html;
	error_page 401 402 403 404 405 406 407 /404.html;
	root /var/www/harrybrwn.com;

	location /api/ {
		proxy_pass http://$api;
	}

	location /old {
		proxy_pass http://$api$request_uri;
		add_header Cache-Control "no-cache";
	}

	location /tanya {
		proxy_pass http://$api;
	}

	location /admin {
		# This one might be fine to let go, all the data is behind a protected
		# api.
		proxy_pass http://$api;
	}

	location /invite {
		proxy_pass http://$api;
	}

	location = /~harry {
		add_header Cache-Control "no-cache";
		types { } default_type "text/html";
		alias /var/www/harrybrwn.com/index.html;
	}

	location /static/ {
		gzip on;
		include snippets/static_gzip.types;
		# Only gzip if 512 bytes or more
		gzip_min_length    512;
		# cache in cdn for 7 days
		add_header         Cache-Control "public, proxy-revalidate, max-age=604800";
		# cache in browser for 1 hour
		add_header         Cache-Control "public, must-revalidate, max-age=3600";
		sendfile           on;
		sendfile_max_chunk 512k;
		tcp_nopush         on;
	}

	location = /sitemap.xml.gz {
		gzip_static on;
		expires     max;
		add_header  Cache-Control public;
		types { } default_type "application/gzip";
	}

	location / {
		autoindex on;
		root /var/www/harrybrwn.com;
		location = /favicon.ico {
			# cache for 7 days
			add_header Cache-Control "public, max-age=604800";
		}
	}

	location = /404.html {
		internal;
		allow      all;
		auth_basic off;
	}

	location ~ ^/(invite_email|harry_y_tanya) {
		internal;
	}
}
